!function(a){Craft.CraftSupportWidget=Garnish.Base.extend({widgetId:0,envInfo:null,loading:!1,$widget:null,$pane:null,$screens:null,$currentScreen:null,$nextScreen:null,screens:null,currentScreen:null,$helpBody:null,$feedbackBody:null,init:function(b,c){this.widgetId=b,this.envInfo=c,Craft.CraftSupportWidget.widgets[this.widgetId]=this,this.$widget=a("#widget"+b),this.$pane=this.$widget.find("> .front > .pane"),this.$screens=this.$pane.find("> .body > .cs-screen"),this.screens={},this.$currentScreen=this.initScreen(Craft.CraftSupportWidget.SCREEN_HOME).$screen},getScreen:function(a){return this.$screens.filter(".cs-screen-"+a+":first")},initScreen:function(a){return"undefined"==typeof this.screens[a]?this.screens[a]=this.loadScreen(a):this.screens[a].reinit(),this.screens[a]},loadScreen:function(a){var b=this.getScreen(a);switch(a){case Craft.CraftSupportWidget.SCREEN_HOME:return new c(this,a,b);case Craft.CraftSupportWidget.SCREEN_HELP:return new e(this,a,b);case Craft.CraftSupportWidget.SCREEN_FEEDBACK:return new f(this,a,b);default:throw"Invalid screen: "+a}},gotoScreen:function(b){this.$nextScreen&&(this.$currentScreen.velocity("stop").css({opacity:0,display:"none"}),this.$nextScreen.velocity("stop").css({opacity:1}),this.$pane.velocity("stop"),this.handleScreenAnimationComplete()),this.$nextScreen=this.getScreen(b).css({display:"block",position:"absolute",left:"0px",top:"0px",width:this.$pane.width()+"px"}),this.$pane.height(this.$pane.height()),this.$currentScreen.velocity({opacity:0},{display:"none"}),this.$nextScreen.velocity({opacity:1}),this.$pane.velocity({height:this.$nextScreen.outerHeight()},{complete:a.proxy(this,"handleScreenAnimationComplete")}),this.currentScreen=this.initScreen(b)},handleScreenAnimationComplete:function(){this.$pane.height("auto"),this.$nextScreen.css({position:"relative",width:"auto"}),this.$currentScreen=this.$nextScreen,this.$nextScreen=null}},{widgets:{},SCREEN_HOME:"home",SCREEN_HELP:"help",SCREEN_FEEDBACK:"feedback"});var b=Garnish.Base.extend({widget:null,screen:null,$screen:null,init:function(a,b,c){this.widget=a,this.screen=b,this.$screen=c,this.afterInit()},afterInit:a.noop,reinit:a.noop}),c=b.extend({afterInit:function(){var a=this.$screen.children(".cs-opt");this.addListener(a,"click","handleOptionClick")},handleOptionClick:function(b){var c=a.attr(b.currentTarget,"data-screen");this.widget.gotoScreen(c)}}),d=b.extend({$body:null,$formContainer:null,mode:null,bodyStartHeight:null,$searchResultsContainer:null,$searchResults:null,$searchForm:null,$searchParams:null,$searchSubmit:null,searchTimeout:null,showingResults:!1,$supportForm:null,$supportMessage:null,$supportAttachment:null,$supportSubmit:null,$supportSpinner:null,$supportErrorList:null,$supportIframe:null,sendingSupportTicket:!1,afterInit:function(){this.$body=this.$screen.find(".cs-body-text:first").focus(),this.$formContainer=this.$screen.children(".cs-forms"),this.$searchResultsContainer=this.$screen.children(".cs-search-results-container:first"),this.$searchResults=this.$searchResultsContainer.find(".cs-search-results:first"),this.$searchForm=this.$formContainer.children(".cs-search-form:first"),this.$searchParams=this.$searchForm.children(".cs-search-params:first"),this.$searchSubmit=this.$searchForm.children(".submit:first"),this.addListener(this.$searchForm,"submit","handleSearchFormSubmit"),this.addListener(this.$searchForm.find("> p > a"),"click","handleSupportLinkClick"),this.$supportForm=this.$formContainer.children(".cs-support-form:first"),this.$supportMessage=this.$supportForm.children("input.cs-support-message");var a=this.$supportForm.children(".cs-support-more");this.$supportAttachment=a.find(".cs-support-attachment:first"),this.$supportSubmit=this.$supportForm.children(".submit:first"),this.$supportSpinner=this.$supportForm.children(".spinner:first"),this.$supportIframe=this.$screen.children("iframe"),this.addListener(this.$supportForm,"submit","handleSupportFormSubmit"),this.bodyStartHeight=this.$body.height(),this.addListener(this.$body,"textchange","handleBodyTextChange"),this.addListener(this.$body,"keydown","handleBodyKeydown"),this.prepForSearch(!1)},handleSearchFormSubmit:function(a){this.$body.val()||a.preventDefault()},handleBodyTextChange:function(){var b=this.$body.val();if(this.mode===d.MODE_SEARCH)if(this.clearSearchTimeout(),this.searchTimeout=setTimeout(a.proxy(this,"search"),500),b){this.$searchParams.html("");var c=this.getFormParams(b);for(var e in c)c.hasOwnProperty(e)&&a("<input/>",{type:"hidden",name:e,value:c[e]}).appendTo(this.$searchParams);this.$searchSubmit.removeClass("disabled")}else this.$searchSubmit.addClass("disabled");else b?(this.$supportMessage.val(b),this.$supportSubmit.removeClass("disabled")):this.$supportSubmit.addClass("disabled")},handleBodyKeydown:function(a){switch(a.keyCode){case Garnish.ESC_KEY:this.mode===d.MODE_SEARCH?this.widget.gotoScreen(Craft.CraftSupportWidget.SCREEN_HOME):this.sendingSupportTicket||this.prepForSearch(!0);break;case Garnish.RETURN_KEY:Garnish.isCtrlKeyPressed(a)&&(this.mode===d.MODE_SEARCH?this.$searchForm.submit():this.$supportForm.submit())}},handleSupportLinkClick:function(){this.prepForSupport(!0)},clearSearchTimeout:function(){this.searchTimeout&&(clearTimeout(this.searchTimeout),this.searchTimeout=null)},search:function(){this.clearSearchTimeout();var b=this.$body.val();if(b){var c=this.getSearchUrl(this.$body.val());a.ajax({url:c,dataType:"json",success:a.proxy(this,"handleSearchSuccess"),error:a.proxy(this,"hideSearchResults")})}else this.hideSearchResults()},handleSearchSuccess:function(b){if(this.mode===d.MODE_SEARCH){var c=this.getSearchResults(b);if(c.length){var e;this.showingResults?e=this.$searchResultsContainer.height():(this.$searchResultsContainer.removeClass("hidden"),e=0,this.showingResults=!0,this.$screen.addClass("with-results")),this.$searchResults.html("");for(var f=Math.min(c.length,20),g=0;g<f;g++)this.$searchResults.append(a("<li>").append(a("<a>",{href:this.getSearchResultUrl(c[g]),target:"_blank",html:'<span class="status '+this.getSearchResultStatus(c[g])+'"></span>'+this.getSearchResultText(c[g])})));var h=this.$searchResultsContainer.height("auto").height();this.$searchResultsContainer.velocity("stop").height(e).velocity({height:h},{complete:a.proxy(function(){this.$searchResultsContainer.height("auto")},this)})}else this.hideSearchResults()}},hideSearchResults:function(){this.mode===d.MODE_SEARCH&&this.showingResults&&(this.$searchResultsContainer.velocity("stop").height(this.$searchResultsContainer.height()).velocity({height:0},{complete:a.proxy(function(){this.$searchResultsContainer.addClass("hidden")},this)}),this.showingResults=!1,this.$screen.removeClass("with-results"))},handleSupportFormSubmit:function(a){return!this.$body.val()||this.sendingSupportTicket?void a.preventDefault():(this.sendingSupportTicket=!0,this.$supportSubmit.addClass("active"),void this.$supportSpinner.removeClass("hidden"))},reinit:function(){this.$body.focus()},prepForSearch:function(a){this.mode=d.MODE_SEARCH,this.$body.velocity("stop").focus(),this.$supportErrorList&&(this.$supportErrorList.remove(),this.$supportErrorList=null),a?this.$body.velocity({height:this.bodyStartHeight}):this.$body.height(this.bodyStartHeight),this.swapForms(this.$supportForm,this.$searchForm,a),this.handleBodyTextChange(),this.search()},prepForSupport:function(a){this.clearSearchTimeout(),this.hideSearchResults(),this.mode=d.MODE_SUPPORT,this.$body.velocity("stop").focus(),a?this.$body.velocity({height:2*this.bodyStartHeight}):this.$body.height(2*this.bodyStartHeight),this.swapForms(this.$searchForm,this.$supportForm,a),this.handleBodyTextChange()},swapForms:function(b,c,d){if(d){this.$formContainer.height(this.$formContainer.height());var e=this.$formContainer.width();b.velocity("stop").css({position:"absolute",top:0,left:0,width:e}).velocity({opacity:0},{complete:function(){b.addClass("hidden").css({position:"relative",width:"auto"})}}),c.velocity("stop").removeClass("hidden").css({position:"absolute",top:0,left:0,width:e}).velocity({opacity:1},{complete:function(){c.css({position:"relative",width:"auto"})}}),this.$formContainer.velocity("stop").velocity({height:c.height()},{complete:a.proxy(function(){this.$formContainer.css({height:"auto"})},this)})}else b.addClass("hidden"),c.removeClass("hidden")},parseSupportResponse:function(b){if(this.sendingSupportTicket=!1,this.$supportSubmit.removeClass("active"),this.$supportSpinner.addClass("hidden"),this.$supportErrorList&&this.$supportErrorList.children().remove(),b.errors){this.$supportErrorList||(this.$supportErrorList=a('<ul class="errors"/>').insertAfter(this.$supportForm));for(var c in b.errors)if(b.errors.hasOwnProperty(c))for(var d=0;d<b.errors[c].length;d++){var e=b.errors[c][d];a("<li>"+e+"</li>").appendTo(this.$supportErrorList)}}b.success&&(Craft.cp.displayNotice(Craft.t("Message sent successfully.")),this.$body.val(""),this.$supportMessage.val(""),this.$supportAttachment.val("")),this.$supportIframe.html("")},getFormParams:function(){throw"getFormParams() must be implemented"},getSearchUrl:function(){throw"getSearchUrl() must be implemented"},getSearchResults:function(){throw"getSearchResults() must be implemented"},getSearchResultUrl:function(){throw"getSearchResultUrl() must be implemented"},getSearchResultStatus:function(){throw"getSearchResultStatus() must be implemented"},getSearchResultText:function(){throw"getSearchResultUrl() must be implemented"}},{MODE_SEARCH:"search",MODE_SUPPORT:"support"}),e=d.extend({getFormParams:function(a){return{title:a}},getSearchUrl:function(a){return"https://api.stackexchange.com/2.2/similar?site=craftcms&sort=relevance&order=desc&title="+encodeURIComponent(a)},getSearchResults:function(a){return a.items||[]},getSearchResultUrl:function(a){return a.link},getSearchResultStatus:function(a){return a.is_answered?"green":""},getSearchResultText:function(a){return a.title}}),f=d.extend({getFormParams:function(a){var b="### Description\n\n\n\n### Steps to reproduce\n\n1.\n2.\n\n### Additional info\n";for(var c in this.widget.envInfo)this.widget.envInfo.hasOwnProperty(c)&&(b+="\n- "+c+": "+this.widget.envInfo[c]);return{title:a,body:b}},getSearchUrl:function(a){return"https://api.github.com/search/issues?q=type:issue+repo:craftcms/cms+"+encodeURIComponent(a)},getSearchResults:function(a){return a.items||[]},getSearchResultUrl:function(a){return a.html_url},getSearchResultStatus:function(a){return"open"===a.state?"green":"red"},getSearchResultText:function(a){return a.title}})}(jQuery);
//# sourceMappingURL=CraftSupportWidget.js.map