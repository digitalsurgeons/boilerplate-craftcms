!function(a){Craft.Locales=Garnish.Base.extend({$addLocaleField:null,$addLocaleInput:null,$addLocaleSpinner:null,$resultsSheet:null,$resultsList:null,$activeLocale:null,locales:null,selectedLocales:null,adminTable:null,inputVal:null,showingResultsSheet:!1,init:function(c,d){this.locales={};for(var e in c)this.locales[e]={name:c[e],words:Craft.asciiString(e+" "+c[e]).match(Craft.Locales.wordRegex)};this.selectedLocales=d,this.$addLocaleField=a("#addlocale"),this.$addLocaleInput=a("#addlocaleinput"),this.$addLocaleSpinner=this.$addLocaleField.find(".spinner"),this.adminTable=new b(this),this.addListener(this.$addLocaleInput,"keydown","onKeyDown"),this.addListener(this.$addLocaleInput,"focus","onFocus"),this.addListener(this.$addLocaleInput,"blur","onBlur")},onKeyDown:function(b){switch(b.keyCode){case Garnish.ESC_KEY:return this.$addLocaleInput.val(""),void this.hideResultsSheet();case Garnish.RETURN_KEY:return b.preventDefault(),void this.addSelectedLocale();case Garnish.UP_KEY:return void this.setRelativeActiveLocale("prev");case Garnish.DOWN_KEY:return void this.setRelativeActiveLocale("next")}setTimeout(a.proxy(this,"checkInputVal"),1)},onFocus:function(){this.inputVal&&this.showResultsSheet()},onBlur:function(){this.hideResultsSheet()},setRelativeActiveLocale:function(a){if(this.$activeLocale){var b=this.$activeLocale.parent()[a]().children("a");b.length&&(this.$activeLocale.removeClass("hover"),b.addClass("hover"),this.$activeLocale=b)}},checkInputVal:function(){if(this.inputVal!==(this.inputVal=this.$addLocaleInput.val())){var b=this.findMatchingLocales();if(b.length){b=b.sort(function(a,b){return a.length-b.length}),this.showResultsSheet(),this.$resultsList.html("");for(var c=0;c<b.length;c++){var d=this.locales[b[c]],e=a("<li/>").appendTo(this.$resultsList),f=a('<a data-id="'+b[c]+'">'+d.name+" ("+b[c]+")</a>").appendTo(e);0==c&&(f.addClass("hover"),this.$activeLocale=f)}}else this.hideResultsSheet(),this.$activeLocale=null}},findMatchingLocales:function(){var a=[],b=Craft.asciiString(this.inputVal).match(Craft.Locales.wordRegex);if(b){for(var c=[],d=0;d<b.length;d++)c.push(new RegExp("^"+b[d],"i"));for(var e in this.locales)if(!Craft.inArray(e,this.selectedLocales)){for(var f=!0,d=0;d<c.length;d++){for(var g=!1,h=0;h<this.locales[e].words.length;h++)if(this.locales[e].words[h].search(c[d])!=-1){g=!0;break}if(!g){f=!1;break}}f&&a.push(e)}}return a},showResultsSheet:function(){this.showingResultsSheet||(this.$resultsSheet||(this.$resultsSheet=a('<div id="addlocaleresults" class="menu" style="position: relative;"/>').appendTo(this.$addLocaleField),this.$resultsList=a("<ul/>").appendTo(this.$resultsSheet),this.addListener(this.$resultsList,"mousedown","addSelectedLocale")),this.$resultsSheet.show(),this.showingResultsSheet=!0)},hideResultsSheet:function(){this.showingResultsSheet&&(this.$resultsSheet.hide(),this.showingResultsSheet=!1)},addSelectedLocale:function(b){var c;if(b)c=a(b.target);else{if(!this.$activeLocale)return;c=this.$activeLocale}this.hideResultsSheet(),this.$addLocaleInput.val(this.$activeLocale.text()).prop("disabled",!0),this.$addLocaleSpinner.removeClass("hidden");var d=c.attr("data-id");Craft.postActionRequest("localization/addLocale",{id:d},a.proxy(function(b,c){if(this.$addLocaleSpinner.addClass("hidden"),"success"==c)if(b.success){var e=a('<tr data-id="'+d+'" data-name="'+this.locales[d].name+'"><th scope="row" data-title="'+Craft.t("Name")+'" width="40%">'+this.locales[d].name+'</th><td data-title="'+Craft.t("Locale ID")+'">'+d+'</td><td class="thin"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>');this.adminTable.addRow(e),this.selectedLocales.push(d),this.$addLocaleInput.val("").prop("disabled",!1).trigger("keydown"),this.checkInputVal(),Craft.cp.displayNotice(Craft.t("New locale added.")),Craft.cp.runPendingTasks()}else Craft.cp.displayError(Craft.t("Unable to add the new locale."))},this))}},{wordRegex:new RegExp("[a-zA-Z]+","g")});var b=Craft.AdminTable.extend({manager:null,confirmDeleteModal:null,$rowToDelete:null,$deleteActionRadios:null,$deleteSubmitBtn:null,$deleteSpinner:null,_deleting:!1,init:function(a){this.manager=a,this.base({tableSelector:"#locales",sortable:!0,minObjects:1,reorderAction:"localization/reorderLocales",deleteAction:"localization/deleteLocale"})},confirmDeleteObject:function(b){return this.confirmDeleteModal&&(this.confirmDeleteModal.destroy(),delete this.confirmDeleteModal),this._createConfirmDeleteModal(b),Garnish.isMobileBrowser(!0)||setTimeout(a.proxy(function(){this.$deleteActionRadios.first().focus()},this),100),!1},onDeleteObject:function(b){var c=a.inArray(b,this.manager.selectedLocales);c!=-1&&this.manager.selectedLocales.splice(c,1),this.base(b)},validateDeleteInputs:function(){var a=this.$deleteActionRadios.eq(0).prop("checked")||this.$deleteActionRadios.eq(1).prop("checked");return a?this.$deleteSubmitBtn.removeClass("disabled"):this.$deleteSubmitBtn.addClass("disabled"),a},submitDeleteLocale:function(b){if(b.preventDefault(),!this._deleting&&this.validateDeleteInputs()){this.$deleteSubmitBtn.addClass("active"),this.$deleteSpinner.removeClass("hidden"),this.disable(),this._deleting=!0;var c={id:this.getObjectId(this.$rowToDelete)};this.$deleteActionRadios.eq(0).prop("checked")&&(c.transferContentTo=this.$transferSelect.val()),Craft.postActionRequest(this.settings.deleteAction,c,a.proxy(function(a,b){"success"==b&&(this._deleting=!1,this.enable(),this.confirmDeleteModal.hide(),this.handleDeleteObjectResponse(a,this.$rowToDelete))},this))}},_createConfirmDeleteModal:function(b){this.$rowToDelete=b;var c=this.getObjectId(b),d=this.getObjectName(b),e=a('<form id="confirmdeletemodal" class="modal fitted" method="post" accept-charset="UTF-8">'+Craft.getCsrfInput()+'<input type="hidden" name="action" value="localization/deleteLocale"/><input type="hidden" name="id" value="'+c+'"/></form>').appendTo(Garnish.$bod),f=a('<div class="body"><p>'+Craft.t("What do you want to do with any content that is only available in {language}?",{language:d})+'</p><div class="options"><label><input type="radio" name="contentAction" value="transfer"/> '+Craft.t("Transfer it to:")+'</label><div id="transferselect" class="select"><select/></div></div><div><label><input type="radio" name="contentAction" value="delete"/> '+Craft.t("Delete it")+"</label></div></div>").appendTo(e),g=a('<div class="buttons right"/>').appendTo(f),h=a('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(g);this.$deleteActionRadios=f.find("input[type=radio]"),this.$transferSelect=a("#transferselect > select"),this.$deleteSubmitBtn=a('<input type="submit" class="btn submit disabled" value="'+Craft.t("Delete {language}",{language:d})+'" />').appendTo(g),this.$deleteSpinner=a('<div class="spinner hidden"/>').appendTo(g);for(var i=0;i<this.manager.selectedLocales.length;i++)this.manager.selectedLocales[i]!=c&&this.$transferSelect.append('<option value="'+this.manager.selectedLocales[i]+'">'+this.manager.locales[this.manager.selectedLocales[i]].name+"</option>");this.confirmDeleteModal=new Garnish.Modal(e),this.addListener(h,"click",function(){this.confirmDeleteModal.hide()}),this.addListener(this.$deleteActionRadios,"change","validateDeleteInputs"),this.addListener(e,"submit","submitDeleteLocale")}})}(jQuery);
//# sourceMappingURL=locales.js.map